import t from"../../../modules/GitApi/index.js";import{defaultBranchMap as r}from"../data/index.js";import{logger as e}from"../../../utils/index.js";import o from"../../../config/index.js";async function n(o){const{provider:n,repo:i,branch:a,type:s}=o;if("commits"!==s||a)return!1;try{const e=await t.getDefaultBranch(n,i);if(!1===e)return!1;if(!e)throw new Error(`接口无效返回: ${e}`);return o.branch=e,r.set(i,e),!0}catch(t){return e.warn(`获取 ${n} 的默认分支失败 ${i}: ${t&&t.message||t}`),!1}}export async function autoFillDefaultBranches(){if(!o.CodeUpdate.AutoBranch)return;const t=(o.CodeUpdate.List||[]).flatMap(t=>t.repos||[]),r=(await Promise.all(t.map(n))).filter(Boolean).length;r>0&&e.info(`已自动获取到 ${e.blue(r)} 个仓库的默认分支`)}