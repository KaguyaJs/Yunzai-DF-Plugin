import{marked as e}from"marked";import{timeAgo as t,Data as r}from"../../../utils/index.js";import a from"../../../config/index.js";import{ResPath as o}from"../../../dir.js";import s from"node:fs";import n from"node:path";import{FacePoke as i}from"../../../modules/index.js";const p=new Set(["pr","feat","fix","docs","style","refactor","perf","test","build","ci","chore","revert"]),m=r.getJSON("Emoji.json","json",!1)||{},c=a.CodeUpdate.repos.reduce((e,t)=>(e[t.provider.toLowerCase()]=t.icon||"",e),{}),u=n.resolve(`${o}/CodeUpdate/icon`),f=s.readdirSync(u);export async function formatCommitInfo(e,r,a,o){const{author:s,committer:n,commit:i,stats:p,files:m,sha:c}=e,u=(i.author?.name&&`<span>${i.author.name}</span>`)??"",f=(i.committer?.name&&`<span>${i.committer.name}</span>`)??"",l=(i.author?.date&&`<span>${t(i.author.date)}</span>`)??"",$=(i.committer?.date&&`<span>${t(i.committer.date)}</span>`)??"",h=u===f?`${u} 提交于 ${l}`:`${u} 编写于 ${l}，并由 ${f} 提交于 ${$}`;return{avatar:{is:s?.avatar_url!==n?.avatar_url,author:s?.avatar_url,committer:n?.avatar_url},name:{source:r,repo:a,branch:o,sha:c.slice(0,5).toUpperCase(),authorStart:i.author?.name?.[0]??"?",committerStart:i.committer?.name?.[0]??"?"},time_info:h,icon:await d(r),text:formatMessage(i.message),stats:!(!p||!m)&&{files:m.length,additions:p.additions??NaN,deletions:p.deletions??NaN}}}export function formatMessage(t){if(!t)return'<span class="head">无提交信息</span>';const r=(t=l(t)).split("\n");if(a.CodeUpdate.badgeStyle){const e=function(e){if(e.toLowerCase().startsWith("merge pull request")){const t=e.match(/#(\d+) from (\S+)/i);if(t)return{type:"pr",subject:`合并 ${t[2]}`,prNum:t[1],isPr:!0}}const t=/^(?:(\p{Emoji}))?\s*(\w+)(?:\(([^)]+)\))?:\s*(.+)$/iu,r=e.match(t);if(r){const[,e,t,a,o]=r;if(p.has(t.toLowerCase()))return{type:t.toLowerCase(),scope:a,subject:o,emoji:e,isPr:!1}}return{type:"unknown",subject:e,isPr:!1}}(r[0].trim());r[0]=function(e){let t="",r="";if(e.isPr){const a=e.prNum?`<span class="pr-num">#${e.prNum}</span>`:"";t='<span class="commit-prefix prefix-pr">PR</span>',r=`<strong>${e.subject}</strong> ${a}`}else if(e.type&&"unknown"!==e.type){t=`<span class="commit-prefix ${`prefix-${e.type}`}${e.emoji?" has-emoji":""}${e.scope?" haveScope":""}">${e.emoji||""}${e.type}</span>`,e.scope&&(t+=`<span class="scope commit-prefix">${e.scope}</span>`),r=e.subject}else r=e.subject;return`${t} <span class="head">${r}</span>`.trim()}(e)}const o=r.slice(1).join("\n").trim();if(!o)return r.join("<br>");let s;try{s=e.lexer(o)}catch{return r.join("<br>")}return s.some(e=>"paragraph"!==e.type||e.raw.includes("\n"))?`${r[0]}<br>${e(o)}`:r.join("<br>")}function l(e){for(const[t,r]of Object.entries(m)){const a=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g");e=e.replace(a,r)}return e}export async function formatReleaseInfo(r,a,o){const{tag_name:s,name:n,body:i,author:p,published_at:m}=r,c=p?.login||p?.name||"?",u=m?`<span>${t(m)}</span>`:"未知",f=e(l(i||""));return{release:!0,avatar:p?.avatar_url,icon:await d(a),name:{source:a,repo:o,tag:s,authorStart:c[0]??"?"},time_info:`<span>${c}</span> 发布于 ${u}`,text:`<span class='head'>${n}</span><br/>${f}`}}async function d(e){const t=c[e.toLowerCase()]||"git",r=f.find(e=>n.parse(e).name.toLowerCase()===t.toLowerCase());return r?n.join(u,r):/^(https?:\/\/|file:\/\/\/|\/|\.\/|[a-zA-Z]:\\)/.test(t)?t:i("从雨")}