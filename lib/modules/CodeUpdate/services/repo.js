import t from"../../../modules/GitApi/index.js";import{defaultBranchMap as a}from"../data/index.js";import{redisHeler as e,formatCommitInfo as i,formatReleaseInfo as r}from"../utils/index.js";import n from"../../../config/index.js";import{logger as o}from"../../../utils/index.js";export async function fetchUpdate(s,m){const c=new Map;return await Promise.all(s.map(async s=>{let{provider:d,repo:p,branch:f,type:u}=s;if(!p)return;let l=p;try{const y=p;"commits"!==u&&"commit"!==u||(u="commits",f||=a.get(p)??""),f&&(l+=":"+f),o.debug(`请求 ${o.magenta(d)} ${u}: ${o.cyan(l)}`);let g=await t.getRepositoryData(d,p,u,f);if(!1===g)return;if(Array.isArray(g)||(g=[g]),0===g.length||"releases"===u&&!g[0]?.tag_name)return void o.warn(`${o.magenta(d)}: ${o.cyan(l)} 数据为空`);if(m){const t="commits"===u&&g[0]?.sha?g[0]?.sha:g[0]?.node_id,a=await e.isUpdate(d,u,p,f,t);if(a)return void o.debug(`${o.cyan(l)} 暂无更新`);if(await e.updatesSha(d,u,p,f,t),null===a&&!n.CodeUpdate.FirstAdd)return;o.mark(`${o.cyan(l)} 检测到更新`)}const $=await("commits"===u?i(g[0],d,y,f):r(g[0],d,p));c.set(s,$)}catch(t){o.error(`获取 ${o.magenta(d)} ${u} ${o.cyan(l)} 数据出错: `,t)}})),c}