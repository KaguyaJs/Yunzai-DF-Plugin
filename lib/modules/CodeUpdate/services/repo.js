import t from"../../../modules/GitApi/index.js";import{defaultBranchMap as a}from"../data/index.js";import{redisHeler as e,formatCommitInfo as i,formatReleaseInfo as r,repoPath as n}from"../utils/index.js";import o from"../../../config/index.js";import{logger as s}from"../../../utils/index.js";export async function fetchUpdate(m,c){const d=new Map;return await Promise.all(m.map(async m=>{let{provider:p,repo:f,branch:u,type:y}=m;if(!f)return;const l=n(f,u);try{const n=f;"commits"!==y&&"commit"!==y||(y="commits",u||=a.get(f)??""),s.debug(`请求 ${s.magenta(p)} ${y}: ${s.cyan(l)}`);let g=await t.getRepositoryData(p,f,y,u);if(!1===g)return;if(Array.isArray(g)||(g=[g]),0===g.length||"releases"===y&&!g[0]?.tag_name)return void s.warn(`${s.magenta(p)}: ${s.cyan(l)} 数据为空`);if(c){const t="commits"===y&&g[0]?.sha?g[0]?.sha:g[0]?.node_id,a=await e.isUpdate(p,y,f,u,t);if(a)return void s.debug(`${s.cyan(l)} 暂无更新`);if(await e.updatesSha(p,y,f,u,t),null===a&&!o.CodeUpdate.FirstAdd)return;s.mark(`${s.cyan(l)} 检测到更新`)}const $=await("commits"===y?i(g[0],p,n,u):r(g[0],p,f));d.set(m,$)}catch(t){s.error(`获取 ${s.magenta(p)} ${y} ${s.cyan(l)} 数据出错: `,t)}})),d}