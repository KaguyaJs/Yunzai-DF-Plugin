import e from"../../config/index.js";import{logger as t,Data as r}from"../../utils/index.js";import{fetchUpdate as o}from"./services/index.js";import{pushTouser as i}from"./services/push.js";import{generateScreenshot as n}from"./services/screenshot.js";import s from"../../utils/GitRepo.js";import{redisHeler as a,repoPath as c}from"./utils/index.js";export async function CodeUpdate(a=!0,p){const{List:f}=e.CodeUpdate;if(!f?.length)return t.warn("未配置推送列表"),p&&await p.reply("请先配置需要监听的仓库"),!1;t.mark(t.cyan("开始检查仓库更新"));const u=getRepos(!0);if(!u.length)return!1;const d=await o(u,a),m=d.size;if(!m)return t.info(t.yellow("未检测到仓库更新")),m;const l=f.reduce((e,t)=>{const r=(e,r)=>{r.forEach(r=>{e[r]||=new Set,t.repos.forEach(t=>e[r].add(t)),t.AutoPath&&s.PluginPath.forEach(o=>{Array.isArray(t.Exclude)&&t.Exclude.includes(c(o.repo,o.branch))||e[r].add(o)})})};return r(e.Group,t.Group??[]),r(e.QQ,t.QQ??[]),e},{Group:{},QQ:{}});const g=new Map;if(!a&&p){const e=await n(Array.from(d.values()),String(p.user_id));return e&&await p.reply(e),m}for(const[e,o]of Object.entries(l))for(const[s,a]of Object.entries(o)){let o;if(!a.size)continue;const c=r.getSetKey(a);if(g.get(c))o=g.get(c);else{const e=Array.from(a).map(e=>d.get(e)).filter(e=>void 0!==e);if(!e.length)continue;o=await n(e,String(s)),o&&g.set(c,o)}o?i(e,s,o):t.warn("[CodeUpdate] 截图失败")}return m}export function getRepos(t){const{List:r}=e.CodeUpdate,o=new Set(r.flatMap(e=>e.repos));return e.AutoPath&&s.PluginPath.forEach(e=>o.add(e)),t?Array.from(o):o}export function getAllRedisKey(){return getRepos(!0).map(({provider:e,repo:t,branch:r,type:o})=>a.getRedisKey(e,"commit"===o?"commits":o,t,r))}