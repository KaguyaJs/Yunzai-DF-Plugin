import r from"node:fs/promises";import{AppsDir as o,PluginName as e}from"../../dir.js";import t from"node:path";import{pathToFileURL as n}from"node:url";import a from"chalk";const g=new Map,c=Date.now();export async function loadApps(){const r={};let s=0,l=0;const f=[];try{const a=await i(o);await Promise.all(a.map(async o=>{try{let t=g.get(o);t||(t=await import(n(o).href),g.set(o,t));for(const[n,a]of Object.entries(t))"function"==typeof a&&a.prototype&&(r[n]?(logger.warn(`[${e}] 已存在 class ${n} 同名导出: ${o}`),l++):(r[n]=a,s++))}catch(r){const n=t.basename(o);"ERR_MODULE_NOT_FOUND"===r?.code?f.push({file:{name:n},error:r}):logger.error(`[${e}] 载入 ${n} 错误：`,r),l++}}))}catch(r){logger.error(`[${e}] 载入插件时发生错误/(ㄒoㄒ)/~~`,r)}return function(r){if(!r.length)return;logger.error(`--------- ${e} 缺少依赖 ---------`);for(const o of r){const r=o.error.stack.match(/'(.+?)'/g)[0].replace(/'/g,"");logger.error(`${logger.cyan(o.file.name)} 缺少 ${logger.red(r)}`)}logger.error(`请使用 ${logger.red("pnpm install")} 安装依赖`),logger.error("如仍报错可将问题反馈给开发者"),logger.error("--------------------------------")}(f),function(...r){const o=Date.now()-c,e="-".repeat(30);logger.info(e);const t=[a.cyanBright.bold,a.greenBright.bold,a.magentaBright.bold,a.yellowBright.bold];r.forEach((r,o)=>{const e=t[o%t.length];logger.info(e(r))}),logger.info(`✅  总耗时: ${o} ms`),logger.info(e)}(`${e} 加载完成 (*^▽^*)`,`成功: ${s} 个`,l>0?`失败: ${l}`:"没有失败 (～￣▽￣)~"),{apps:r}}async function i(o){try{const e=await r.readdir(o,{withFileTypes:!0}),n=[];for(const r of e){const e=t.join(o,r.name);r.isDirectory()?n.push(...await i(e)):r.name.endsWith(".js")&&n.push(e)}return n}catch(r){return logger.error("读取插件失败:",r),[]}}