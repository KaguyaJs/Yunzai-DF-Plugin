import{request as t,logger as e}from"../../utils/index.js";import a from"../../config/index.js";const r={GitHub:"https://api.github.com/repos",Gitee:"https://gitee.com/api/v5/repos",Gitcode:"https://api.gitcode.com/api/v5/repos",CNB:"https://api.cnb.cool"};function s(t){const e=(a?.CodeUpdate?.repos??[]).reduce((t,e)=>(e.provider&&e.ApiUrl&&(t[e.provider.toLowerCase()]={apiUrl:e.ApiUrl,token:e.token??""}),t),{}),s=String(t||"").toLowerCase();return e[s]||(r[s]?{apiUrl:r[s]}:{})}export default new class{async getRepositoryData(t,a,r,n){const i=String(t||""),o=/gitea/i.test(i),c=/gitee/i.test(i),p=/gitcode/i.test(i),h=/cnb/i.test(i),{apiUrl:m,token:g}=s(t);if(!m)return e.error(`未知数据源: ${t}`),!1;const u=new URL(m);"commits"===r&&n?o?(u.pathname=`${u.pathname}/${a}/commits`,u.searchParams.set("page","1"),u.searchParams.set("sha",n)):h?u.pathname=`${u.pathname}${u.pathname.endsWith("/")?"":"/"}${a}/-/git/commits/${n}`:(u.pathname=`${u.pathname}/${a}/commits/${n}`,p&&u.searchParams.set("show_diff","true")):h?(u.pathname=`${u.pathname}/${a}/-/git/${r}`,u.searchParams.set("page","1")):(u.pathname=`${u.pathname}/${a}/${r}`,o?u.searchParams.set("page","1"):u.searchParams.set("per_page","1")),c&&g&&u.searchParams.set("access_token",g);const $=this.getHeaders(t,g);try{e.debug("请求 URL:",u.toString());return await this.fetchData(u,$,a,t)}catch(t){return e.error("获取仓库数据失败",{url:u.toString(),err:t}),!1}}async getDefaultBranch(t,a){const{apiUrl:r,token:n}=s(t);if(!r)return e.error(`未知数据源: ${t}`),!1;const i=/cnb/i.test(String(t||""));let o=`${r}/${a}`;i&&(o=`${r}/${a}/-/git/head`);const c=this.getHeaders(t,n),p=await this.fetchData(o,c,a,t);return!!p&&(i?p.name??"":p.default_branch??"")}getHeaders(t,e){const a=String(t||""),r={"User-Agent":"request",Accept:(()=>{switch(a){case"GitHub":return"application/vnd.github+json";case"Gitee":return"application/vnd.gitee+json";default:return"application/json"}})()};return e&&(r.Authorization=`Bearer ${e}`),r}async fetchData(a,r={},s,n){try{const i=await t.get(a,"raw",{headers:r});if(!i)return!1;if(!i.ok){let t=`状态码：${i.status} ${i?.statusText||""}`;switch(i.status){case 400:t="参数错误 (code: 400)";break;case 401:t="访问令牌无效或已过期 (code: 401)";break;case 403:t="请求达到Api速率限制或无权限，请尝试填写token或降低请求频率后重试 (code: 403)";break;case 404:t="未找到仓库 (code: 404)";break;case 500:t="服务器错误 (code: 500)"}return e.error(`请求 ${e.magenta(String(n))} 失败: ${e.cyan(String(s))}, ${t}`),!1}return(i.headers?.get?.("content-type")??"").includes("application/json")?await i.json():(e.error(`响应非 JSON 格式: ${a} , 内容：${await i.text()}`),!1)}catch(t){return e.error(`请求失败: ${a}，错误信息: ${t?.stack??t}`),!1}}};