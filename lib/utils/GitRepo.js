import t from"node:fs/promises";import o from"node:path";import{YunzaiPath as e}from"../dir.js";import r from"../config/index.js";import{createTimer as n}from"./time.js";import{logger as i}from"./logger.js";import{exec as c}from"./exec.js";export const PluginPath=[];export let Loading=!1;let a=new Set(["data","node_modules","temp","logs","cache","dist"]);const s=[];export function registerHost(t,o){s.push({key:String(t),pattern:o})}Object.entries({GitHub:"github.com",Gitee:"gitee.com",Gitcode:"gitcode.com",CNB:"cnb.cool"}).forEach(([t,o])=>{var e;registerHost(t,new RegExp(`${e=o,e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}[:/](?<repo>[^/]+\\/[^/]+?)(?:\\.git)?$`,"i"))});export function setIgnore(t){a=new Set(t)}export function addIgnore(t){for(const o of t)a.add(o)}export async function isGitRepo(e){try{return await t.access(o.join(e,".git")),!0}catch{return!1}}export async function execCmd(t,o){try{const e=await c(o,t,!0);return("string"==typeof e?e:String(e)).trim()}catch(t){throw new Error(t?.message||String(t))}}export async function loadLocalPlugins(t=e){Loading=!0;const r=n();i.mark("正在载入本地Git仓库列表"),r.start(),PluginPath.length=0;try{const e=await findRepos(o.resolve(t));for(const t of Object.keys(e)){const o=e[t];for(const e of o)PluginPath.push({provider:t,repo:e.repo,branch:e.branch,type:"commit"})}}catch(t){throw i.error("加载本地Git仓库时出错:",t),t}finally{Loading=!1,i.mark(`本地Git仓库载入完成, 耗时: ${r.end()}`)}}export async function findRepos(t){const o={};for(const t of s)o[t.key]=[];return await traverse(t,o),o}export async function traverse(e,r){try{await isGitRepo(e)&&await collectRepoInfo(e,r);const n=await t.readdir(e,{withFileTypes:!0});for(const t of n){if(!t.isDirectory())continue;if(a.has(t.name))continue;const n=o.join(e,t.name);try{await traverse(n,r)}catch(t){i.warn(`无法扫描子文件夹: ${n} -> ${t}`)}}}catch(t){i.warn(`无法扫描文件夹: ${e} -> ${t}`)}}export async function collectRepoInfo(t,o){try{let e="HEAD";try{const o=await execCmd(t,"git rev-parse --abbrev-ref HEAD");o&&(e=o.split(/\r?\n/)[0].trim())}catch{try{const o=await execCmd(t,"git branch --show-current");o&&(e=o.split(/\r?\n/)[0].trim())}catch{}}let r="origin";try{const o=await execCmd(t,`git config branch.${e}.remote`);o&&(r=o)}catch{}let n="";try{n=(await execCmd(t,`git remote get-url ${r}`)).trim()}catch{try{const o=await execCmd(t,"git remote -v");for(const t of o.split(/\r?\n/)){const o=t.match(/\s*(\S+)\s+(\S+)\s+\(fetch\)/);if(o){n=o[2];break}}}catch{}}if(!n)return void i.warn(`仓库未发现远程地址: ${t}`);classify(n.trim(),e,o)}catch(o){i.warn(`Git仓库信息收集失败: ${t} -> ${o}`)}}export function classify(t,o,e){for(const{key:r,pattern:n}of s){const i=t.match(n);if(i&&i.groups?.repo){const t=r;return e[t]||(e[t]=[]),void e[t].push({repo:i.groups.repo,branch:o})}}i.debug&&i.debug(`无法识别远程地址平台: ${t}`)}r.AutoPath&&loadLocalPlugins().catch(t=>i.warn("载入本地Git仓库失败",t));export default{registerHost,loadLocalPlugins,setIgnore,addIgnore,PluginPath,hosts:s};