import e from"fs/promises";import{Marked as n}from"marked";export async function parseChangelog(r,t={}){const{limit:s=1/0,includeIntro:i=!1,headingLevel:o=2}=t,a=String(await e.readFile(r,"utf8")).replace(/\r\n/g,"\n").split("\n"),l="#".repeat(o),p=new RegExp(`^${l}\\s*(?:\\[(?<ver1>[^\\]]+)\\](?:\\((?<link>[^)]+)\\))?|(?<ver2>[^\\s(]+))(?:\\s*\\((?<date>\\d{4}-\\d{2}-\\d{2})\\))?\\s*$`),u=[];let g=null,c={},d=[],h=0;const m=[];let f=!1;const v={strong(e){const n=this.parser.parseInline(e.tokens),r=n.replace(/\s+$/,"");if(r.endsWith(":")){return`<strong class="scope">${r.replace(/:$/,"")}</strong>`}return`<strong>${n}</strong>`}},k=new n;k.use({renderer:v});for(let e=0;e<a.length;e++){const n=a[e],r=p.exec(n.trim());if(r&&(r.groups?.ver1||r.groups?.ver2)){if(!f&&(f=!0,i&&m.length>0)){const e=m.join("\n").trim();if(e&&(u.push({version:"intro",header:`${l} intro`,raw:e,html:k.parse(e)}),h++,h>=s))return u}if(null!==g){const e=d.join("\n").trim();if(u.push({version:c.version??"unknown",header:g,date:c.date,link:c.link,raw:e,html:e?await k.parse(e):""}),h++,h>=s)return u}g=n.trim(),c={version:r.groups?.ver1??r.groups?.ver2,link:r.groups?.link,date:r.groups?.date},d=[]}else f?d.push(n):m.push(n)}if(null!==g&&h<s){const e=d.join("\n").trim();u.push({version:c.version??"unknown",header:g,date:c.date,link:c.link,raw:e,html:e?await k.parse(e):""})}return u}export async function getRecentChangelogEntries(e,n=3){return parseChangelog(e,{limit:n,includeIntro:!1,headingLevel:2})}