import{CodeUpdate as e,getAllRedisKey as t}from"../modules/CodeUpdate/index.js";import{Loading as s}from"../utils/index.js";import i from"../../../../lib/common/common.js";import{CodeUpdateRedisKey as r}from"../constants/index.js";import a from"../config/index.js";export class GitRepoUpdate extends plugin{constructor(){super({name:"DF:Git仓库更新推送",dsc:"监听Git仓库更新并推送至群或私聊",event:"message",priority:5e3,rule:[{reg:"^#?(检查|推送)仓库更新$",fnc:"check",permission:"master"},{reg:/^#?DF清理无效数据$/i,fnc:"clear",permission:"master"}]}),a.CodeUpdate.Auto&&(this.task={name:"DF:Git仓库更新检查",cron:a.CodeUpdate.Cron,fnc:async()=>{await e(!0)}})}async check(t=this.e){const s=t.msg.includes("推送");await t.reply(`正在${s?"推送":"检查"}仓库更新，请稍等`);const i=await e(!s,t);return!1!==i&&(s?void 0:t.reply(i>0?`检查完成，共有${i}个仓库有更新，正在按照你的配置进行推送哦~`:"检查完成，没有发现仓库有更新"))}async clear(e){if(s)return e.reply("❎ 请等待本地仓库载入完成哦~");const a=t(),n=(await redis.keys(`${r}:*`)).filter(e=>!a.includes(e)),{length:o}=n;if(!(o>0))return e.reply("✅ 你的设备很干净，无需清理");await e.reply(`⚠️ 本次需清理${o}个key, 如需清理请发送 #确认清理`),e.redisInvalidKeys=n,await e.reply(await i.makeForwardMsg(e,["无效键名列表",...n])),this.setContext("startClear")}async startClear(e){const t=this.e;if(/^#?确认清理$/i.test(t.msg)){const s=await redis.del(e.redisInvalidKeys);await t.reply(`✅ 成功清理${s}个无效数据`)}else await t.reply("❎ 已取消");this.finish("startClear")}}