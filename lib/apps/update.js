import{update as e}from"../../../other/update.js";import{FacePath as t,PluginName as a}from"../dir.js";import s from"../utils/data.js";import{FaceRepoUrl as i}from"../constants/index.js";import{exec as r}from"../utils/index.js";let n=!1;export class DFUpdate extends plugin{constructor(){super({name:"DF:更新插件",event:"message",priority:1e3,rule:[{reg:/^#DF(插件)?(强制)?更新(日志)?$/i,fnc:"update"},{reg:/^#?DF(安装|(强制)?更新)(戳一戳)?图库$/i,fnc:"upImg"}]})}async update(t=this.e){const s=t.msg.includes("日志"),i=s?"#更新日志":t.msg.includes("强制")?"#强制更新":"#更新";t.msg=i+a;const r=new e;return r.e=t,s?r.updateLog():r.update()}async upImg(e=this.e){if(e.isMaster){if(n)return e.reply("已有更新任务正在进行中，请勿重复操作！");n=!0;try{let a,n="",p="";if(await s.isDirectory(t)){const t=e.msg.includes("强制");n="git pull --rebase",t&&(n=`git reset --hard origin/HEAD && ${n}`),p=`开始${t?"强制":""}更新图库啦，请主人稍安勿躁~`,a="update"}else n=`git clone --depth=1 ${i} ${t}`,p="开始安装戳一戳图库,可能需要一段时间,请主人稍安勿躁~",a="install";await e.reply(p),await r(n,"update"===a?t:void 0).then(async t=>{if("update"===a)if(/Already up to date/.test(t)||t.includes("最新"))await e.reply("目前所有图片都已经是最新了~");else{const a=/(\d*) files changed,/.exec(t);a&&a[1]?await e.reply(`更新成功，共更新了${a[1]}张图片~`):await e.reply("戳一戳图片资源更新完毕")}else await e.reply("戳一戳图库安装成功！您后续也可以通过 #DF更新图库 命令来更新图片")}).catch(t=>{e.reply(`图片资源${"update"===a?"更新":"安装"}失败！\nError code: ${t?.code}\n${t?.stack}\n 请尝试${"update"===a?"使用 #DF强制更新图库 或":""}稍后重试。`)})}finally{n=!1}}}}