import e from"../config/index.js";import{getSourceMessage as s,isExpired as t}from"../utils/index.js";const r="DF:whoAtme";export class whoAtme extends plugin{constructor(){super({name:"DF:谁艾特我",dsc:"谁艾特我",event:"message.group",priority:5e3,rule:[{reg:/^#?(?:谁|哪个叼毛)(?:艾特|at|@)我$/i,fnc:"who"}]})}async accept(i=this.e){if(!e.whoAtme.enable)return!1;const a=Array.from(new Set(i.message.filter(e=>"at"===e.type).map(e=>e.qq)));if(!a.length)return!1;const o=i.message.filter(e=>"long_msg"!==e.type),n=await s(i);if(n&&n.message_id){o.unshift(segment.reply(n.message_id));const e=o.findIndex(e=>"at"===e.type&&e.qq===n.sender.user_id);-1!==e&&o.splice(e,1)}const m={user_id:i.user_id,nickname:i.sender.nickname,time:i.time,message:o},{expireTime:c}=e.whoAtme,g=async e=>{const s=`${r}:${i.group_id}:${e}`,a=await redis.get(s);if(a){const e=JSON.parse(a);e.forEach((s,r)=>{t(s.time,c)&&e.splice(r,1)}),e.push(m),await redis.set(s,JSON.stringify(e),{EX:c})}else await redis.set(s,JSON.stringify([m]),{EX:c})},p=[];for(const s of a)if("all"===s){if(!e.whoAtme.atAll)continue;const s=await i.group.getMemberMap();Array.from(s.keys()).filter(e=>!a.includes(e)).forEach(e=>p.push(g(e)))}else p.push(g(s));return await Promise.all(p),!1}async who(s=this.e){if(!e.whoAtme.enable)return!1;const t=`${r}:${s.group_id}:${s.user_id}`,i=await redis.get(t);if(!i)return this.reply("还没有人艾特你哦");const a=JSON.parse(i);if(!a?.length)return this.reply("没有，嘿嘿");let o;const n=s.member;return o=a.some(e=>e.message.some(e=>"image"===e.type||"video"===e.type))?Bot.makeForwardMsg(a):n.raw.makeForwardMsg?await n.raw.makeForwardMsg(a):n.makeForwardMsg?await n.makeForwardMsg(a):Bot.makeForwardMsg(a),s.reply(o)}}