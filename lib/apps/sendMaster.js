import e from"../config/index.js";import*as r from"../utils/index.js";import{ulid as s}from"ulid";import{FacePoke as t}from"../modules/index.js";import i from"moment";import{sendMasterRedisKey as a}from"../constants/index.js";let n=!1;const o=a,p=/^#?回复(\S+)?\s?(.*)?$/;export class sendMasterMsg extends plugin{constructor(){super({name:"DF:联系主人",dsc:"给主人带话",event:"message",priority:400,rule:[{reg:"^#?联系主人",fnc:"sendMaster"},{reg:p,fnc:"Replys",event:"message.private"}]})}async sendMaster(a=this.e){if(n)return a.reply("❎ 已有发送任务正在进行中，请等待上一条完成后重试");const{open:p,cd:l,BotId:m,banWords:g,banUser:u,banGroup:d,MsgTemplate:c,successMsgTemplate:f,failsMsgTemplate:y,Master:M}=e.sendMaster,b=`${o}:cd`;if(!a.isMaster){if(!p)return a.reply("❎ 该功能暂未开启，请先让主人开启才能用哦",!0);if(0!==l&&await redis.get(b))return a.reply("❎ 操作频繁，请稍后再试",!0);if(g.some(e=>a.msg.includes(e)))return a.reply("❎ 消息包含违禁词，请检查后重试",!0);if(u.includes(a.user_id))return a.reply("❎ 对不起，您不可用",!0);if(a.isGroup&&d.includes(a.group_id))return a.reply("❎ 该群暂不可用该功能",!0)}n=!0;try{const e=r.ReplaceMessage(a,/#联系主人/);if(0===e.length)return a.reply("❎ 消息不能为空");const n=s().slice(-5),p={platform:a.bot?.version?.id||a.adapter_id||"未知",avatar:segment.image((a.isGroup?a.member.getAvatarUrl():a.friend?.getAvatarUrl?.())||await t("all")),user:`${a.sender.nickname}(${a.user_id})`,group:a.isGroup?`${a.group.name||"未知群名"}(${a.group_id})`:"私聊",bot:`${a.bot.nickname}(${a.bot.uin})`,time:i().format("YYYY-MM-DD HH:mm:ss"),key:`联系主人消息(${n})`,msg:e},l=r.parseTemplate(c,p),g={bot:a.bot.uin||Number(Bot.uin)||String(Bot.uin),gid:a.isGroup?a.group_id:null,uid:a.user_id,mid:a.message_id},u=["first","all"][Number(M)]||"one",d=await r.sendMasterMsg(l,Bot[m]?.uin||a.self_id,u,M),y=r.parseTemplate(f,{masterQQ:Object.values(d).flatMap(e=>Object.keys(e)).toString()});await a.reply(y),b&&await redis.set(b,"1"),await redis.set(`${o}:${n}`,JSON.stringify(g),{EX:86400})}catch(s){const t=r.parseTemplate(y,{masterQQ:String(e.masterQQ[0])});await a.reply(t),logger.error(s)}finally{n=!1}}async Replys(s=this.e){if(!s.isMaster)return!1;try{const t=await r.getSourceMessage(s);let i,a=!1;if(t&&/联系主人消息/.test(t.raw_message))i=r.extractMessageId(t.raw_message)||"";else{const e=p.exec(s.msg);if(!e?.[1])return logger.warn("未找到消息ID"),!1;i=e[1].trim(),a=!0}if(!i)return!1;const n=await redis.get(`${o}:${i}`);if(!n)return!a&&s.reply("❎ 消息已失效或不存在");const{bot:l,gid:m,uid:g,mid:u}=JSON.parse(n),d=r.ReplaceMessage(s,a?/#?回复(\S+)\s?/:/#?回复/g),c=r.parseTemplate(e.sendMaster.replyMsgTemplate,{nickname:s.nickname||s.sender?.nickname||"未知",id:String(s.user_id),msg:d});c.unshift(segment.reply(u));const f=Bot[l]??Bot;m?await f.pickGroup(m).sendMsg(c):await f.pickFriend(g).sendMsg(c),await s.reply("✅ 消息已送达")}catch(e){return s.reply("❎ 发生错误，请查看控制台日志"),logger.error("回复消息时发生错误：",e),!1}}}