name: Release and Push to Build
on:
  workflow_dispatch:
  push:
    branches:
      - main
permissions:
  contents: write # è®¾ç½®å†…å®¹çš„æƒé™ä¸ºå†™
  pull-requests: write # è®¾ç½®æ‹‰å–è¯·æ±‚çš„æƒé™ä¸ºå†™
  issues: write # è®¾ç½®é—®é¢˜çš„æƒé™ä¸ºå†™
jobs:
  release-please:
    # è®¾ç½®å·¥ä½œæµç¨‹è¿è¡Œç¯å¢ƒä¸º Ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ ä½¿ç”¨ release-please-action å‘å¸ƒæ£€æŸ¥
        uses: googleapis/release-please-action@v4
        id: release
        with:
          # è®¾ç½®å‘å¸ƒç±»å‹ä¸º Node.js
          release-type: node

      - name: âš™ï¸ æ£€å‡º Yunzai ä»£ç 
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/checkout@v5
        with:
          repository: KaguyaJs/TRSS-Yunzai

      - name: ğŸ”© æ£€å‡ºæ’ä»¶ä»£ç 
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/checkout@v5
        with:
          path: plugins/temp-plugin

      - name: ğŸª› è®¾ç½® Node.js ç¯å¢ƒ
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/setup-node@v4
        with:
          # è®¾ç½® Node.js ç‰ˆæœ¬
          node-version: 24

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        if: ${{ steps.release.outputs.release_created }}
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: |
            - args: ["--registry=https://registry.npmjs.org"]

      - name: ğŸ”§ ç¼–è¯‘æºä»£ç 
        if: ${{ steps.release.outputs.release_created }}
        run: |
          cd plugins/temp-plugin
          pnpm run build

      - name: ğŸ§± å‡†å¤‡æ‰€éœ€è¦çš„æ–‡ä»¶
        if: ${{ steps.release.outputs.release_created }}
        run: |
          cd plugins/temp-plugin

          mkdir -p temp_lib_content

          for f in $(jq -r '.files[]' package.json); do
            if [ -e "$f" ]; then
              dest="temp_lib_content/$f"
              mkdir -p "$(dirname "$dest")"
              cp -R "$f" "$dest"
              echo "[copy] $f"
            else
              echo "[skip] $f not exists"
            fi
          done

          echo "node_modules/" > temp_lib_content/.gitignore

      - name: ğŸ§¹ åˆ é™¤å¼€å‘ä¾èµ–
        if: ${{ steps.release.outputs.release_created }}
        run: |
          cd plugins/temp-plugin/temp_lib_content
          pnpm pkg delete devDependencies

      - name: ğŸ“Œ éƒ¨ç½²åˆ°åˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v4
        if: ${{ steps.release.outputs.release_created }}
        with:
          # è¿™æ˜¯ GitHub é»˜è®¤æä¾›çš„ Tokenï¼Œå…·æœ‰å†™å…¥æƒé™
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # è¦æ¨é€åˆ°çš„ç›®æ ‡åˆ†æ”¯
          publish_branch: build
          # åŒ…å«è¦æ¨é€æ–‡ä»¶/ç›®å½•çš„æ–‡ä»¶å¤¹
          publish_dir: plugins/temp-plugin/temp_lib_content
          # æ¯æ¬¡æäº¤æ—¶ä¿ç•™å†å²è®°å½•
          force_orphan: false
          # ä¿æŒåŸæäº¤ä¿¡æ¯
          full_commit_message: ${{ github.event.head_commit.message }}
          # è®¾ç½®æäº¤ç”¨æˆ·å
          user_name: "github-actions[bot]"
          # è®¾ç½®æäº¤é‚®ç®±
          user_email: "github-actions[bot]@users.noreply.github.com"
